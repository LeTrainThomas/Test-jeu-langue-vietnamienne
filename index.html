<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tri Cosm√©tiques : Recyclable ou Perturbateur ?</title>
  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --card:#111827;         /* gray-900 */
      --muted:#94a3b8;        /* slate-400 */
      --text:#e5e7eb;         /* gray-200 */
      --accent:#38bdf8;       /* sky-400 */
      --good:#22c55e;         /* green-500 */
      --bad:#ef4444;          /* red-500 */
      --warm:#f59e0b;         /* amber-500 */
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
    html,body{height:100%;}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 50% -200px, #1e293b, var(--bg));
      color:var(--text);
    }
    .app{max-width:560px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;}

    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(15,23,42,0.9), rgba(15,23,42,0.6));backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(148,163,184,.15);}
    .topbar{display:flex;align-items:center;gap:.6rem;padding:.8rem .9rem .6rem;}
    .title{font-weight:800;letter-spacing:.2px;font-size:1.05rem;}
    .pill{border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:.35rem .7rem; font-size:.78rem;color:var(--muted)}
    .actions{margin-left:auto;display:flex;gap:.4rem}
    .btn-icon{border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text);border-radius:12px;padding:.5rem;display:grid;place-items:center}
    .btn-icon:active{transform:scale(.98)}

    .countries{display:flex;gap:.5rem;overflow:auto;padding:0 .9rem .8rem}
    .chip{flex:0 0 auto;padding:.55rem .9rem;border-radius:999px;border:1.5px solid rgba(148,163,184,.25);color:var(--muted);font-weight:700;font-size:.9rem;background:#0b1220}
    .chip.active{border-color:var(--accent);color:#081018;background:linear-gradient(180deg,#7dd3fc,#38bdf8);}

    .progress{height:8px;background:#0b1220;border-radius:999px;margin:.3rem .9rem .9rem;border:1px solid rgba(148,163,184,.15);overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#38bdf8); transition:width .4s ease}

    main{flex:1;display:flex;align-items:center;justify-content:center;padding:1rem .9rem 5.5rem}

    .card{width:100%;background:linear-gradient(180deg,#0b1220,#0b1220 60%,#0a0f1c);border:1px solid rgba(148,163,184,.15);border-radius:22px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:1rem;}
    .tag{display:inline-flex;gap:.4rem;align-items:center;font-size:.78rem;color:var(--muted);border:1px dashed rgba(148,163,184,.3);padding:.25rem .55rem;border-radius:10px}
    .item-title{font-size:1.35rem;font-weight:900;margin:.6rem 0 .3rem;letter-spacing:.2px}
    .desc{color:var(--muted);font-size:.95rem;margin:.2rem 0 .8rem}
    .choices{display:grid;gap:.6rem}
    .choice{
      border-radius:16px;padding:1rem 1rem;display:flex;align-items:center;justify-content:space-between;
      font-weight:900;font-size:1.05rem;border:1.5px solid rgba(148,163,184,.2);background:#0b1220;}
    .choice span{opacity:.9}
    .choice .hint{font-weight:700;font-size:.8rem;color:var(--muted)}
    .choice.good{border-color:rgba(34,197,94,.6);background:linear-gradient(180deg, rgba(34,197,94,.12), rgba(34,197,94,.05));}
    .choice.bad{border-color:rgba(239,68,68,.6);background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.05));}
    .choice:active{transform:scale(.99)}

    .explain{margin-top:.8rem;font-size:.92rem;line-height:1.25rem;color:var(--muted)}
    .explain strong{color:var(--text)}

    .bottomsheet{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,#0b1220,#0b1220);
      border-top:1px solid rgba(148,163,184,.2);border-radius:16px 16px 0 0;padding:.7rem .9rem env(safe-area-inset-bottom);
      display:flex;gap:.5rem;align-items:center}
    .cta{flex:1;border:none;background:linear-gradient(180deg,#7dd3fc,#38bdf8);color:#081018;font-weight:900;padding:1rem;border-radius:14px;font-size:1.05rem}
    .sec{flex:0 0 auto;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text);font-weight:800;padding:.9rem;border-radius:14px}

    .toast{position:fixed;left:50%;bottom:6.5rem;transform:translateX(-50%);background:#0b1220;border:1px solid rgba(148,163,184,.25);padding:.6rem .8rem;border-radius:12px;color:var(--muted);font-weight:700;opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:560px;margin:0 auto;background:#0b1220;border-radius:16px 16px 0 0;border:1px solid rgba(148,163,184,.2);padding:1rem .9rem calc(1rem + env(safe-area-inset-bottom));}
    .sheet h3{margin:.2rem 0 .6rem;font-size:1.1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    .toggle{display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(148,163,184,.25);padding:.6rem .7rem;border-radius:12px}
    .toggle label{font-size:.9rem;color:var(--muted)}
    .toggle input{transform:scale(1.2)}

    .end{display:none;flex-direction:column;gap:1rem;align-items:center;text-align:center}
    .end .score{font-size:2.2rem;font-weight:900}
    .end .again{padding:1rem 1.2rem;font-weight:900;border-radius:14px;border:none;background:linear-gradient(180deg,#7dd3fc,#38bdf8)}

    /* fun confetti */
    .confetti{pointer-events:none;position:fixed;inset:0;overflow:hidden}
    .confetti i{position:absolute;width:8px;height:16px;background:linear-gradient(180deg,#7dd3fc,#22c55e);opacity:.9;border-radius:2px;animation:fall 900ms linear forwards}
    @keyframes fall{to{transform:translateY(100vh) rotate(600deg);opacity:0}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="title">‚ôªÔ∏è Tri Cosm√©tiques</div>
        <div class="pill">Mobile ‚Ä¢ tactile</div>
        <div class="actions">
          <button class="btn-icon" id="btnRules" aria-label="R√®gles locales">üìú</button>
          <button class="btn-icon" id="btnInfo" aria-label="√Ä propos">‚ÑπÔ∏è</button>
        </div>
      </div>
      <div class="countries" id="countryChips" role="tablist" aria-label="Pays">
        <!-- chips inserted by JS -->
      </div>
      <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
    </header>

    <main>
      <div class="card" id="card">
        <!-- Game card injected here -->
      </div>
      <div class="end" id="end">
        <div class="score" id="scoreText">0 / 0</div>
        <div class="desc">Tu as termin√© ce parcours. Tu peux rejouer ou ajuster les r√®gles locales (üìú) pour coller √† ta r√©alit√© terrain.</div>
        <button class="again" id="again">Rejouer</button>
      </div>
    </main>

    <div class="bottomsheet">
      <button class="sec" id="btnPrev">‚óÄÔ∏é Pr√©c.</button>
      <button class="cta" id="btnNext">Suivant ‚ñ∂Ô∏é</button>
    </div>

    <div class="toast" id="toast">Petit rappel : ces r√®gles sont simplifi√©es pour le jeu. Ajuste via üìú si besoin.</div>

    <!-- Modal R√®gles locales -->
    <div class="modal" id="rulesModal" aria-hidden="true" aria-labelledby="rulesTitle">
      <div class="sheet">
        <h3 id="rulesTitle">üìú R√®gles locales (simplifi√©es)</h3>
        <p class="desc">Chaque pays peut avoir des consignes diff√©rentes. Tu peux ajuster ci‚Äëdessous ce que tu consid√®res <strong>recyclable</strong> (ON) ou <strong>perturbateur</strong> (OFF) pour chaque item.</p>
        <div id="rulesGrid"></div>
        <div style="display:flex;gap:.5rem;margin-top:.8rem">
          <button class="sec" id="resetRules">R√©initialiser</button>
          <button class="cta" id="saveRules">Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- Modal Info -->
    <div class="modal" id="infoModal" aria-hidden="true" aria-labelledby="infoTitle">
      <div class="sheet">
        <h3 id="infoTitle">‚ÑπÔ∏è √Ä propos</h3>
        <p class="desc">
          Ce mini‚Äëjeu √©ducatif t‚Äôentra√Æne √† reconna√Ætre les emballages cosm√©tiques <strong>recyclables</strong> et ceux qui sont <strong>perturbateurs</strong> selon le pays.
          Les r√®gles int√©gr√©es sont <em>p√©dagogiques et simplifi√©es</em> ‚Äî elles ne remplacent pas les consignes officielles locales. Utilise üìú pour les adapter.
        </p>
        <button class="cta" id="closeInfo">OK</button>
      </div>
    </div>

    <div class="confetti" id="confetti"></div>
  </div>

  <script>
    // --- Data ---------------------------------------------------------------
    const COUNTRIES = [
      { id:'FR', name:'France üá´üá∑' },
      { id:'DE', name:'Allemagne üá©üá™' },
      { id:'UK', name:'Royaume‚ÄëUni üá¨üáß' },
    ];

    const ITEMS = [
      { id:'lip_abs', emoji:'üíÑ', title:'Rouge √† l√®vres en ABS', spec:'Petit format, corps en ABS.', tips:'Beaucoup de centres ne trient pas l‚ÄôABS en flux m√©nager. Favoriser les recharges / retours boutique.' },
      { id:'pet_lbl', emoji:'üß¥', title:'Shampooing PET transparent + √©tiquette opaque', spec:'Bouteille PET claire, √©tiquette couvrante.', tips:'Les √©tiquettes opaques larges peuvent perturber la reconnaissance optique. √âtiquette d√©tachable = mieux.' },
      { id:'pp_jar', emoji:'ü´ô', title:'Pot de cr√®me en PP opaque', spec:'Pot rigide en polypropyl√®ne.', tips:'Le PP rigide est souvent accept√© dans les fili√®res modernes.' },
      { id:'pp_compact', emoji:'üé®', title:'Bo√Ætier de maquillage en PP', spec:'Petit bo√Ætier compact en PP (sans miroir).', tips:'Les tr√®s petits formats peuvent √™tre mal capt√©s. Conception mono‚Äëmati√®re = atout.' },
      { id:'pe_opaque', emoji:'üöø', title:'Flacon de douche en PE opaque', spec:'Bouteille HDPE/PE, pigment√©e.', tips:'Pigments (ex. noir de carbone) peuvent g√™ner le tri NIR. Privil√©gier pigments d√©tectables.' },
    ];

    // Valeurs par d√©faut (purement p√©dagogiques). true=recyclable, false=perturbateur
    const DEFAULT_RULES = {
      FR: { lip_abs:false, pet_lbl:false, pp_jar:true,  pp_compact:true,  pe_opaque:true },
      DE: { lip_abs:false, pet_lbl:true,  pp_jar:true,  pp_compact:false, pe_opaque:true },
      UK: { lip_abs:false, pet_lbl:false, pp_jar:true,  pp_compact:false, pe_opaque:true },
    };

    // Explications contextuelles par pays + item
    const EXPLAINS = {
      FR: {
        pet_lbl: "√âtiquette opaque couvrante : souvent class√© perturbateur si non d√©tachable.",
        pp_compact: "Format mono‚Äëmati√®re PP : capt√© plus souvent depuis l‚Äôextension des consignes.",
      },
      DE: {
        pet_lbl: "Flux PET clair performant : √©tiquettes prises en charge si sp√©cifi√©es.",
        pp_compact: "Tr√®s petit format : risque de rejet, d‚Äôo√π classification perturbateur.",
      },
      UK: {
        pet_lbl: "Les √©tiquettes opaques peuvent orienter vers la fraction r√©siduelle.",
      }
    };

    // --- State --------------------------------------------------------------
    let state = {
      country: localStorage.getItem('tri_country') || 'FR',
      index: 0,
      answers: [], // {itemId, isRecyclable(bool), correct(bool)}
      rules: loadRules(),
    };

    function loadRules(){
      const raw = localStorage.getItem('tri_rules');
      if(!raw){ return JSON.parse(JSON.stringify(DEFAULT_RULES)); }
      try{ const parsed = JSON.parse(raw); return {...DEFAULT_RULES, ...parsed}; }catch{ return JSON.parse(JSON.stringify(DEFAULT_RULES)); }
    }
    function saveRules(){ localStorage.setItem('tri_rules', JSON.stringify(state.rules)); }

    // --- UI build -----------------------------------------------------------
    const chipsWrap = document.getElementById('countryChips');
    const bar = document.getElementById('bar');
    const card = document.getElementById('card');
    const end = document.getElementById('end');
    const scoreText = document.getElementById('scoreText');

    function renderChips(){
      chipsWrap.innerHTML = '';
      COUNTRIES.forEach(c => {
        const b = document.createElement('button');
        b.className = 'chip' + (state.country===c.id?' active':'');
        b.role = 'tab';
        b.setAttribute('aria-selected', state.country===c.id);
        b.textContent = c.name;
        b.onclick = ()=>{ state.country = c.id; localStorage.setItem('tri_country', state.country); showToast(`${c.name} s√©lectionn√©¬∑e`); render(); };
        chipsWrap.appendChild(b);
      })
    }

    function progress(){
      const pct = Math.round((state.index)/ITEMS.length*100);
      bar.style.width = pct + '%';
    }

    function vibrate(ms){ try{ window.navigator.vibrate && window.navigator.vibrate(ms);}catch(e){} }

    function confettiBurst(){
      const root = document.getElementById('confetti');
      for(let i=0;i<22;i++){
        const f=document.createElement('i');
        f.style.left = Math.random()*100 + 'vw';
        f.style.top = '-10px';
        f.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`;
        f.style.animationDuration = 500 + Math.random()*700 + 'ms';
        root.appendChild(f);
        setTimeout(()=>f.remove(),1200);
      }
    }

    function renderCard(){
      const it = ITEMS[state.index];
      const countryRules = state.rules[state.country];
      const msg = EXPLAINS?.[state.country]?.[it.id] || it.tips;
      card.innerHTML = `
        <div class="tag">${it.emoji} <span>${it.spec}</span></div>
        <div class="item-title">${it.title}</div>
        <div class="desc">Pays s√©lectionn√© : <strong>${COUNTRIES.find(c=>c.id===state.country).name}</strong></div>
        <div class="choices">
          <button class="choice" id="btnRecy">
            <span>‚úÖ Recyclable</span>
            <span class="hint">Flux accept√©</span>
          </button>
          <button class="choice" id="btnPert">
            <span>‚ö†Ô∏è Perturbateur</span>
            <span class="hint">√Ä √©co‚Äëconcevoir</span>
          </button>
        </div>
        <div class="explain" id="exp">${msg}</div>
      `;

      // answer handlers
      document.getElementById('btnRecy').onclick = ()=>answer(true);
      document.getElementById('btnPert').onclick = ()=>answer(false);

      // style buttons based on previous answer if exists
      const prev = state.answers.find(a=>a.itemId===it.id && a.country===state.country);
      if(prev){
        const correct = prev.correct;
        document.getElementById('btnRecy').classList.toggle('good', correct && prev.isRecyclable);
        document.getElementById('btnRecy').classList.toggle('bad', !correct && prev.isRecyclable);
        document.getElementById('btnPert').classList.toggle('good', correct && !prev.isRecyclable);
        document.getElementById('btnPert').classList.toggle('bad', !correct && !prev.isRecyclable);
      }
    }

    function answer(isRecyclable){
      const it = ITEMS[state.index];
      const correct = state.rules[state.country][it.id] === isRecyclable;
      // store/replace answer for this item+country
      const idx = state.answers.findIndex(a=>a.itemId===it.id && a.country===state.country);
      const record = { itemId:it.id, country:state.country, isRecyclable, correct };
      if(idx>-1) state.answers.splice(idx,1,record); else state.answers.push(record);

      // feedback
      const btnR = document.getElementById('btnRecy');
      const btnP = document.getElementById('btnPert');
      btnR.classList.remove('good','bad');
      btnP.classList.remove('good','bad');
      const msgBox = document.getElementById('exp');

      if(correct){
        (isRecyclable?btnR:btnP).classList.add('good');
        confettiBurst(); vibrate(10);
        msgBox.innerHTML = '<strong>Juste !</strong> ' + (EXPLAINS?.[state.country]?.[it.id] || it.tips);
      } else {
        (isRecyclable?btnR:btnP).classList.add('bad');
        vibrate([8,40,8]);
        const expected = state.rules[state.country][it.id] ? 'recyclable' : 'perturbateur';
        msgBox.innerHTML = `‚ùå R√©ponse attendue : <strong>${expected.toUpperCase()}</strong>. ${EXPLAINS?.[state.country]?.[it.id] || it.tips}`;
      }

      saveProgress();
    }

    function saveProgress(){ localStorage.setItem('tri_answers', JSON.stringify(state.answers)); }

    function loadProgress(){
      try{ state.answers = JSON.parse(localStorage.getItem('tri_answers')||'[]') || []; }catch{ state.answers=[]; }
    }

    function next(){
      if(state.index < ITEMS.length-1){ state.index++; render(); }
      else finish();
    }
    function prev(){ if(state.index>0){ state.index--; render(); }
    }

    function finish(){
      const correct = state.answers.filter(a=> a.country===state.country && a.correct).length;
      scoreText.textContent = `${correct} / ${ITEMS.length}`;
      card.style.display='none';
      end.style.display='flex';
    }

    function resetGame(){
      state.index=0; end.style.display='none'; card.style.display='block';
      render();
    }

    function render(){
      renderChips();
      progress();
      renderCard();
    }

    // --- Rules Modal -------------------------------------------------------
    const rulesModal = document.getElementById('rulesModal');
    const infoModal = document.getElementById('infoModal');
    const rulesGrid = document.getElementById('rulesGrid');

    function openRules(){
      rulesModal.classList.add('open');
      buildRulesGrid();
    }
    function closeRules(){ rulesModal.classList.remove('open'); }

    function buildRulesGrid(){
      rulesGrid.innerHTML='';
      COUNTRIES.forEach(c=>{
        const h = document.createElement('h3'); h.textContent = c.name; h.style.marginTop='0.8rem'; rulesGrid.appendChild(h);
        const wrap = document.createElement('div'); wrap.className='grid';
        ITEMS.forEach(it=>{
          const row = document.createElement('div'); row.className='toggle';
          row.innerHTML = `<label>${it.emoji} ${it.title}</label>`;
          const sw = document.createElement('input'); sw.type='checkbox'; sw.checked = !!state.rules[c.id][it.id];
          sw.onchange = ()=>{ state.rules[c.id][it.id] = !!sw.checked; };
          row.appendChild(sw); wrap.appendChild(row);
        });
        rulesGrid.appendChild(wrap);
      });
    }

    document.getElementById('saveRules').onclick = ()=>{ saveRules(); closeRules(); showToast('R√®gles mises √† jour ‚úîÔ∏é'); render(); };
    document.getElementById('resetRules').onclick = ()=>{ state.rules = JSON.parse(JSON.stringify(DEFAULT_RULES)); saveRules(); buildRulesGrid(); showToast('R√®gles r√©initialis√©es'); };

    document.getElementById('btnRules').onclick = openRules;
    rulesModal.addEventListener('click', (e)=>{ if(e.target===rulesModal) closeRules(); });

    // Info modal
    document.getElementById('btnInfo').onclick = ()=> infoModal.classList.add('open');
    document.getElementById('closeInfo').onclick = ()=> infoModal.classList.remove('open');
    infoModal.addEventListener('click', (e)=>{ if(e.target===infoModal) infoModal.classList.remove('open'); });

    // Toast helpers
    const toast = document.getElementById('toast');
    let toastTimer;
    function showToast(txt){
      toast.textContent = txt; toast.classList.add('show');
      clearTimeout(toastTimer); toastTimer = setTimeout(()=>toast.classList.remove('show'), 1600);
    }

    // Bottom controls
    document.getElementById('btnNext').onclick = next;
    document.getElementById('btnPrev').onclick = prev;
    document.getElementById('again').onclick = resetGame;

    // Init
    loadProgress();
    render();
    setTimeout(()=> toast.classList.add('show'), 800);
    setTimeout(()=> toast.classList.remove('show'), 3400);
  </script>
</body>
</html>